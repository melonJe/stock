#docker network create --driver=bridge --subnet 172.20.0.0/16 --gateway 172.20.0.1 melon-net
#docker volume create stock_db_volume
services:
  stock_db:
    image: postgres:17.6
    container_name: stock-postgres
    networks:
      - melon-net
    restart: always
    ports:
      - "15432:5432"
    env_file:
      - .env.db
    environment:
      - TZ=Asia/Seoul
    volumes:
      - ./stock_db_volume:/var/lib/postgresql/data
      - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/healthcheck.sh"]
      interval: 10s
      timeout: 5s
      retries: 5

  stock:
    image: stock:latest
    container_name: stock
    networks:
      - melon-net
    restart: always
    ports:
      - "18000:8000"
    env_file:
      - .env.stock
    environment:
      - TZ=Asia/Seoul
      - ENVIRONMENT=${ENVIRONMENT:-production}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      stock_db:
        condition: service_healthy

networks:
  melon-net:
    name: melon-net
    external: true
